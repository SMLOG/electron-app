<template>
  <div class="main-panel">
    <div id="main-content">
      <div class="main-panel frame clearfix">
        <div class="param-panel">
          <div class="title-box"><h2>参数设置</h2></div>
          <ul class="param-list">
            <li class="param clearfix" data-name="cost">
              <div class="name">初期投入</div>
              <div class="value">
                <input type="text" value="10000" autocomplete="off" />
              </div>
              <div class="unit">￥</div>
            </li>
            <li class="param clearfix" data-name="cash_flow">
              <div class="name">产生的现金流</div>
              <ul class="years clearfix">
                <li class="year" data-year="1">
                  <div class="year-label">第1年</div>
                  <div class="value">
                    <input type="text" value="0" autocomplete="off" />
                  </div>
                  <div class="unit">￥</div>
                </li>
                <li class="year" data-year="2">
                  <div class="year-label">第2年</div>
                  <div class="value">
                    <input type="text" value="0" autocomplete="off" />
                  </div>
                  <div class="unit">￥</div>
                </li>
                <li class="year" data-year="3">
                  <div class="year-label">第3年</div>
                  <div class="value">
                    <input type="text" value="0" autocomplete="off" />
                  </div>
                  <div class="unit">￥</div>
                </li>
                <li class="year" data-year="4">
                  <div class="year-label">第4年</div>
                  <div class="value">
                    <input type="text" value="0" autocomplete="off" />
                  </div>
                  <div class="unit">￥</div>
                </li>
                <li class="year" data-year="5">
                  <div class="year-label">第5年</div>
                  <div class="value">
                    <input type="text" value="0" autocomplete="off" />
                  </div>
                  <div class="unit">￥</div>
                </li>
                <li class="year" data-year="6">
                  <div class="year-label">第6年</div>
                  <div class="value">
                    <input type="text" value="0" autocomplete="off" />
                  </div>
                  <div class="unit">￥</div>
                </li>
                <li class="year" data-year="7">
                  <div class="year-label">第7年</div>
                  <div class="value">
                    <input type="text" value="0" autocomplete="off" />
                  </div>
                  <div class="unit">￥</div>
                </li>
                <li class="year" data-year="8">
                  <div class="year-label">第8年</div>
                  <div class="value">
                    <input type="text" value="0" autocomplete="off" />
                  </div>
                  <div class="unit">￥</div>
                </li>
                <li class="year" data-year="9">
                  <div class="year-label">第9年</div>
                  <div class="value">
                    <input type="text" value="0" autocomplete="off" />
                  </div>
                  <div class="unit">￥</div>
                </li>
                <li class="year" data-year="10">
                  <div class="year-label">第10年</div>
                  <div class="value">
                    <input type="text" value="0" autocomplete="off" />
                  </div>
                  <div class="unit">￥</div>
                </li>
                <li class="year" data-year="11">
                  <div class="year-label">第11年</div>
                  <div class="value">
                    <input type="text" value="0" autocomplete="off" />
                  </div>
                  <div class="unit">￥</div>
                </li>
                <li class="year" data-year="12">
                  <div class="year-label">第12年</div>
                  <div class="value">
                    <input type="text" value="0" autocomplete="off" />
                  </div>
                  <div class="unit">￥</div>
                </li>
                <li class="year" data-year="13">
                  <div class="year-label">第13年</div>
                  <div class="value">
                    <input type="text" value="0" autocomplete="off" />
                  </div>
                  <div class="unit">￥</div>
                </li>
                <li class="year" data-year="14">
                  <div class="year-label">第14年</div>
                  <div class="value">
                    <input type="text" value="0" autocomplete="off" />
                  </div>
                  <div class="unit">￥</div>
                </li>
                <li class="year" data-year="15">
                  <div class="year-label">第15年</div>
                  <div class="value">
                    <input type="text" value="0" autocomplete="off" />
                  </div>
                  <div class="unit">￥</div>
                </li>
                <li class="year" data-year="16">
                  <div class="year-label">第16年</div>
                  <div class="value">
                    <input type="text" value="0" autocomplete="off" />
                  </div>
                  <div class="unit">￥</div>
                </li>
                <li class="year" data-year="17">
                  <div class="year-label">第17年</div>
                  <div class="value">
                    <input type="text" value="0" autocomplete="off" />
                  </div>
                  <div class="unit">￥</div>
                </li>
                <li class="year" data-year="18">
                  <div class="year-label">第18年</div>
                  <div class="value">
                    <input type="text" value="0" autocomplete="off" />
                  </div>
                  <div class="unit">￥</div>
                </li>
                <li class="year" data-year="19">
                  <div class="year-label">第19年</div>
                  <div class="value">
                    <input type="text" value="0" autocomplete="off" />
                  </div>
                  <div class="unit">￥</div>
                </li>
                <li class="year" data-year="20">
                  <div class="year-label">第20年</div>
                  <div class="value">
                    <input type="text" value="0" autocomplete="off" />
                  </div>
                  <div class="unit">￥</div>
                </li>
                <li class="year" data-year="21">
                  <div class="year-label">第21年</div>
                  <div class="value">
                    <input type="text" value="0" autocomplete="off" />
                  </div>
                  <div class="unit">￥</div>
                </li>
                <li class="year" data-year="22">
                  <div class="year-label">第22年</div>
                  <div class="value">
                    <input type="text" value="0" autocomplete="off" />
                  </div>
                  <div class="unit">￥</div>
                </li>
                <li class="year" data-year="23">
                  <div class="year-label">第23年</div>
                  <div class="value">
                    <input type="text" value="0" autocomplete="off" />
                  </div>
                  <div class="unit">￥</div>
                </li>
                <li class="year" data-year="24">
                  <div class="year-label">第24年</div>
                  <div class="value">
                    <input type="text" value="0" autocomplete="off" />
                  </div>
                  <div class="unit">￥</div>
                </li>
                <li class="year" data-year="25">
                  <div class="year-label">第25年</div>
                  <div class="value">
                    <input type="text" value="0" autocomplete="off" />
                  </div>
                  <div class="unit">￥</div>
                </li>
                <li class="year" data-year="26">
                  <div class="year-label">第26年</div>
                  <div class="value">
                    <input type="text" value="0" autocomplete="off" />
                  </div>
                  <div class="unit">￥</div>
                </li>
                <li class="year" data-year="27">
                  <div class="year-label">第27年</div>
                  <div class="value">
                    <input type="text" value="0" autocomplete="off" />
                  </div>
                  <div class="unit">￥</div>
                </li>
                <li class="year" data-year="28">
                  <div class="year-label">第28年</div>
                  <div class="value">
                    <input type="text" value="0" autocomplete="off" />
                  </div>
                  <div class="unit">￥</div>
                </li>
                <li class="year" data-year="29">
                  <div class="year-label">第29年</div>
                  <div class="value">
                    <input type="text" value="0" autocomplete="off" />
                  </div>
                  <div class="unit">￥</div>
                </li>
                <li class="year" data-year="30">
                  <div class="year-label">第30年</div>
                  <div class="value">
                    <input type="text" value="0" autocomplete="off" />
                  </div>
                  <div class="unit">￥</div>
                </li>
              </ul>
            </li>
          </ul>
        </div>
        <div class="controller-banner clearfix">
          <div class="controller-bar">
            <div class="progress"></div>
            <div>
              <input name="calculate" type="button" value="计算" />
              <input name="reset" type="button" value="重置" />
            </div>
          </div>
        </div>
        <div class="result-panel">
          <div class="title-box"><h2>计算结果</h2></div>
          <ul class="result-list clearfix">
            <li class="result clearfix" data-name="irr">
              <div class="name">收益率</div>
              <div class="value">
                <input
                  type="text"
                  value=""
                  disabled="disabled"
                  autocomplete="off"
                />
              </div>
              <div class="unit">%</div>
            </li>
          </ul>
        </div>
      </div>
      <div id="guide-panel">
        <div class="panel panel-default">
          <div class="panel-heading">
            <h3 class="panel-title">
              <span class="ui-icon ui-icon-triangle-1-s"></span>
              <span class="titletext" style="">使用说明</span>
            </h3>
          </div>
          <div class="panel-body">
            <ol>
              <li>
                <a
                  href="http://wiki.mbalib.com/wiki/内部收益率法"
                  ref="nofollow"
                  target="_blank"
                  >内部收益率法</a
                >(Internal Rate of
                Return，IRR法)又称财务内部收益率法(FIRR)、内部报酬率法、内含报酬率。
              </li>
              <li>内部收益率就是使企业投资净现值为零的那个贴现率</li>
            </ol>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>


<script>
import { mapActions, mapGetters, mapState } from "vuex";
import axios from "axios";
import _ from "lodash";
var date = new Date();
var thisYear = date.getFullYear();
const INFINITY_SIGN = "∞";

export default {
  data: function () {
    return {
      baseCashFlow: 1,
      discountRate: 12,
      baseYear: thisYear - 1,
      stages: [
        {
          growthRate: 15,
          to: thisYear - 1 + 10,
          presentValue: null,
        },
        {
          growthRate: 7,
          to: Infinity,
          presentValue: null,
        },
      ],
    };
  },
  components: {},
  computed: {
    sumPresentValue() {
      var sum = 0;
      for (var i = 0; i < this.stages.length; i++) {
        sum += this.stages[i].presentValue;
      }
      return sum;
    },
  },
  mounted() {},

  methods: {
    cleanPresentValue() {
      for (var i = 0; i < this.stages.length; i++) {
        this.stages[i].presentValue = null;
      }
    },
    deleteStage(index) {
      this.stages.splice(index, 1);
      this.cleanPresentValue();
    },
    addStage() {
      var stageSize = this.stages.length;
      var newStage = null;
      if (stageSize > 0) {
        var lastStage = this.stages[stageSize - 1];
        if (lastStage.to === Infinity) {
          if (stageSize > 1) {
            var secondLastStage = this.stages[stageSize - 2];
            if (secondLastStage.to === undefined) {
              lastStage.to = undefined;
            } else {
              lastStage.to = secondLastStage.to + 10;
            }
          } else {
            lastStage.to = thisYear + 10;
          }
        }
        newStage = {
          growthRate: 7,
          to: Infinity,
          presentValue: null,
        };
      } else {
        newStage = {
          growthRate: 7,
          to: Infinity,
          presentValue: null,
        };
      }
      this.stages.push(newStage);
      this.cleanPresentValue();
    },
    calculate() {
      var baseCashFlow = this.baseCashFlow;
      for (var i = 0; i < this.stages.length; i++) {
        var stage = this.stages[i];
        var years = 0;
        var r = (1 + stage.growthRate / 100) / (1 + this.discountRate / 100);
        var endCashFlowMultiples = 0;
        var presentValueMultiples = 0;
        if (stage.to != Infinity) {
          if (i == 0) {
            years = stage.to - this.baseYear;
          } else {
            var previousStage = this.stages[i - 1];
            years = stage.to - previousStage.to;
          }
          endCashFlowMultiples = Math.pow(r, years);
          if (r == 1) {
            presentValueMultiples = years;
          } else {
            presentValueMultiples = ((1 - endCashFlowMultiples) * r) / (1 - r);
          }
        } else {
          presentValueMultiples = r / (1 - r);
        }
        stage.presentValue = baseCashFlow * presentValueMultiples;
        baseCashFlow = baseCashFlow * endCashFlowMultiples;
      }
    },

    getStageName(index) {
      var stageName = "第" + (index + 1) + "阶段";
      if (this.stages[index].to === Infinity) {
        stageName = "永续阶段";
      }
      return stageName;
    },
  },
  watch: {},
};
</script>

<style scoped>
.ui-icon {
  width: 16px;
  height: 16px;
}
.ui-icon {
  display: inline-block;
}
.ui-icon-close {
  background-position: -80px -128px;
}
.ui-icon,
.ui-widget-content .ui-icon {
  background-image: url(ui-icons.png);
}
.clearfix {
  height: 1%;
  overflow: visible;
}

.clearfix:after {
  clear: both;
  content: ".";
  display: block;
  height: 0;
  visibility: hidden;
  font-size: 0;
}
#item-list {
}
.item {
  margin-bottom: 20px;
}
.item .title {
  font-size: 12px;
  border-bottom: 1px solid #ddd;
  margin-bottom: 10px;
}
.item .title a {
  color: #444;
  text-decoration: none;
}
.item .description {
  text-indent: 2em;
  margin-bottom: 5px;
}
.main-panel {
  padding: 10px;
}
.title-box {
  border-bottom: 1px solid #ddd;
  margin-bottom: 10px;
}

button,
input,
optgroup,
select,
textarea {
  margin: 0;
  font: inherit;
  color: inherit;
}
ul,
ol {
  margin-top: 0;
  margin-bottom: 10px;
}

#item-list {
}
.item {
  margin-bottom: 20px;
}
.item .title {
  font-size: 12px;
  border-bottom: 1px solid #ddd;
  margin-bottom: 10px;
}
.item .title a {
  color: #444;
  text-decoration: none;
}
.item .description {
  text-indent: 2em;
  margin-bottom: 5px;
}
.main-panel {
  padding: 10px;
}
.title-box {
  border-bottom: 1px solid #ddd;
  margin-bottom: 10px;
}
.param,
.result {
  padding-left: 120px;
}
.param {
  margin-bottom: 0px;
  padding-top: 18px;
}
.param .name,
.param .value,
.param .unit,
.param .selector,
.param .remark,
.result .name,
.result .value,
.result .unit {
  float: left;
}
.param .name,
.result .name {
  width: 120px;
  margin-left: -120px;
}
.param .value,
.result .value {
  width: 66px;
}
.param .value input,
.result .value input {
  width: 100%;
}
.param .unit,
.result .unit {
  width: 26px;
  margin-left: 10px;
}
.param .selector {
  width: 300px;
  margin-top: -18px;
  margin-left: 40px;
}
.param .slider {
  margin-top: 4px;
}
.param .remark {
  margin-left: 10px;
}
.slider-range .min {
  float: left;
}
.slider-range .max {
  float: right;
}
.controller-banner {
  margin: 10px 0;
}
.controller-bar {
  float: right;
  padding-left: 40px;
}
.progress {
  display: none;
  float: left;
  margin-left: -30px;
}
.result-panel {
}
.param-list,
.result-list {
  list-style: none;
  padding-left: 0;
}
.result-list {
  margin-top: 28px;
}
.result {
  margin-bottom: 18px;
}
.year {
  float: left;
  margin-bottom: 5px;
  margin-right: 5px;
}
</style>

